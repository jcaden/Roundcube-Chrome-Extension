<html>
<head>
<script type="text/javascript">

  function getWebmailUrl() {
    if (!localStorage.domain) {
        return false;
    } else {
        return "https://" + localStorage.domain;
    }
  }

  function isWemmailUrl(webmailUrl, url) {
    if (url.indexOf(webmailUrl) != 0)
        return false;

    return url.length == webmailUrl.length || url[webmailUrl.length] == '?' ||
                       url[webmailUrl.length] == '#';
  }

  function openMail() {
    var webmailUrl = getWebmailUrl();

    if (webmailUrl == false) {
      webmailUrl = "options.html";
      chrome.tabs.create({url: webmailUrl});
    } else {
      chrome.tabs.getAllInWindow(undefined, function(tabs) {
        for (var i = 0, tab; tab = tabs[i]; i++) {
          if (tab.url && isWemmailUrl(webmailUrl, tab.url)) {
            chrome.tabs.update(tab.id, {selected: true});
            return;
          }
        }

        chrome.tabs.create({url: webmailUrl});
      });
    }
  }

</script>
</head>
<body>
<script type="text/javascript">
  chrome.browserAction.onClicked.addListener(openMail);
</script>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-20902801-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = 'https://ssl.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</body>
</html>
